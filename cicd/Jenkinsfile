import groovy.json.*

pipeline {
    agent  any
	options {
	    timeout(time: 30, unit: 'MINUTES')
	    retry(1)
        timestamps()
    }
    environment {
        /* _version = createVersion() */
        _container_name = 'tr-center-web-frontend'
        _branch_name = getGitBranchName()
        _build_user = getChanges()
    }
    stages {
    	stage("environment") {
    	    steps {
    	        nodejs("node12.18.2") {
                    sh 'node -v'
                    sh 'npm -v'
                    sh 'npm config ls'
                    sh 'npm install'
    	        }
            }
    	}
    	stage("build project") {
    	    steps {
    	        nodejs("node12.18.2") {
                    sh 'npm run build'
    	        }
            }
    	}
    	stage("file transfer") {
    	    steps {
    	        sh 'rm -rf ./${_container_name}-temp'
    	        sh 'mkdir ./${_container_name}-temp'
    	        sh 'cp -r ./dist ./${_container_name}-temp'
    	        sh 'cp Dockerfile ./${_container_name}-temp'
    	        sh 'tar -czvf ${_container_name}.tar ./${_container_name}-temp'
    	        sh 'scp ./${_container_name}.tar root@192.168.0.11:~'
            }
    	}
    	stage("build docker image") {
    	    steps {
    	        sh 'ssh root@192.168.0.11 "tar zxvf ~/${_container_name}.tar"'
    	        sh 'ssh root@192.168.0.11 "docker build -t 192.168.0.11:8082/fe/nginx-fe-${_container_name} ./${_container_name}-temp"'
            }
    	}
    	stage("run docker container") {
    	    steps {
                /* sh 'docker save -o ${_container_name}.tar 192.168.0.12:8082/fe/nginx-fe-${_container_name}'
                sh 'scp -o StrictHostKeyChecking=no ${_container_name}.tar root@192.168.0.11:~'
                sh 'ssh root@192.168.0.11 "docker load < ${_container_name}.tar"' */

    	        sh 'ssh root@192.168.0.11 "docker ps -f name=${_container_name} -q | xargs -r docker stop"'
    	        sh 'ssh root@192.168.0.11 "docker ps -a -f name=${_container_name} -q | xargs -r docker rm"'
    	        sh 'ssh root@192.168.0.11 "docker run -itd -p 18853:80 \
    	            --name ${_container_name} \
                    --restart always \
                    -v /home/docker/tr-project/nginx/html:/usr/share/nginx/html \
                    -v /home/docker/tr-project/nginx/conf:/etc/nginx/conf.d \
                    192.168.0.11:8082/fe/nginx-fe-${_container_name}"'
            }
    	}
    }
    post {
        success {
            dingtalk (
                robot: 'mac',
                type: 'MARKDOWN',
                title: 'ğŸ˜Š Successful $JOB_NAME ',
                text: [
                    '# <font color="#0089FF">$JOB_NAME - Build & Deploy  Successful ! ğŸ˜Š</font>',
                    '---',
                    '- é¡¹ç›®åç§°ï¼š<font color="#0089FF">é“œä»åœ°ç†ä¿¡æ¯æ•°æ®ä¸­å°-å‰ç«¯</font>',
                    '- ä»»åŠ¡ç±»å‹ï¼š<font color="#0089FF">æ„å»ºéƒ¨ç½²</font>',
                    '- ä»»åŠ¡çŠ¶æ€ï¼š<font color="#52C41A">æˆåŠŸ</font>',
                    '- éƒ¨ç½²ç¯å¢ƒï¼š<font color="#0089FF">å¼€å‘ç¯å¢ƒ</font>',
                    '- ä»£ç åˆ†æ”¯ï¼š${GIT_BRANCH}',
                    '- æ„å»ºç¼–å·ï¼š${BUILD_NUMBER}',
                    '- æ„å»ºäººå‘˜ï¼š${_build_user}',
                    '- æ„å»ºæ—¥å¿—ï¼š${BUILD_URL}console',
                    '- é¡¹ç›®åœ°å€ï¼šhttp://192.168.0.11:18853/index/indexPage'
                ]
            )
        }
        failure {
            dingtalk (
                robot: 'mac',
                type: 'MARKDOWN',
                title: 'ğŸ˜” Failure $JOB_NAME ',
                text: [
                    '# <font color="#ff0000">$JOB_NAME - Build & Deploy  Failure ! ğŸ˜”</font>',
                    '---',
                    '- é¡¹ç›®åç§°ï¼š<font color="#0089FF">é“œä»åœ°ç†ä¿¡æ¯æ•°æ®ä¸­å°-å‰ç«¯</font>',
                    '- ä»»åŠ¡ç±»å‹ï¼š<font color="#0089FF">æ„å»ºéƒ¨ç½²</font>',
                    '- ä»»åŠ¡çŠ¶æ€ï¼š<font color="#ff0000">å¤±è´¥</font>',
                    '- éƒ¨ç½²ç¯å¢ƒï¼š<font color="#0089FF">å¼€å‘ç¯å¢ƒ</font>',
                    '- ä»£ç åˆ†æ”¯ï¼š${GIT_BRANCH}',
                    '- æ„å»ºç¼–å·ï¼š${BUILD_NUMBER}',
                    '- æ„å»ºäººå‘˜ï¼š${_build_user}',
                    '- æ„å»ºæ—¥å¿—ï¼š${BUILD_URL}console',
                    '- é¡¹ç›®åœ°å€ï¼šhttp://192.168.0.11:18853/index/indexPage'
                ],
                at: [
                    '15156015902'
                ]
            )
        }
    }

}

def createVersion() {
    // å®šä¹‰ä¸€ä¸ªç‰ˆæœ¬å·ä½œä¸ºå½“æ¬¡æ„å»ºçš„ç‰ˆæœ¬ï¼Œè¾“å‡ºç»“æœ 20191210175842_69
    return new Date().format('yyyyMMddHHmmss') + "_${env.BUILD_ID}"
}

def getGitBranchName() {
    return scm.branches[0].name
}

@NonCPS
def getBuildUser() {
    return currentBuild.rawBuild.getCause(Cause.UserIdCause).getUserId()
}

class MyChange {
   String author;
   String msg;
}

@NonCPS
def getChanges()
{
    def changeLogSets = currentBuild.changeSets
    for (int i = 0; i < changeLogSets.size(); i++)
    {
        def entries = changeLogSets[0].items
        for (int j = 0; j < entries.length; j++)
        {
            def entry = entries[0]
            def change = new MyChange()
            change.author = entry.author
            return change.author
        }
    }

}
